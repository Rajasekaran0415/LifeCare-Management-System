<!DOCTYPE html>
<html>
<head>
    <title>Patient Report Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5 p-4 bg-white shadow rounded" style="max-width: 600px;">
    <h2 class="text-center text-primary mb-4">Patient Report</h2>

    <div id="patientInfo" class="text-center mb-3">
        <h5 id="displayName">Loading...</h5>
    </div>

    <p class="text-center text-muted">
        Click the button below to download your medical report.
    </p>

    <div class="d-grid mt-4">
        <button id="downloadBtn" class="btn btn-success btn-lg">
            Download Patient Report (PDF)
        </button>
    </div>
    
    <div class="text-center mt-3">
        <a href="index.html" class="btn btn-link">Back to Home</a>
    </div>
</div>

<script>
    // 1. Page load aagum podhu Session-la irundhu ID matrum Name-ah edukkirom
    // Login success aagum podhu idhai neenga save pannirukkanum:
    // sessionStorage.setItem("patientId", data.id);
    // sessionStorage.setItem("patientName", data.name);

    const patientId = sessionStorage.getItem("patientId");
    const patientName = sessionStorage.getItem("patientName");

    // UI-la name-ah kaatta
    if (patientName) {
        document.getElementById("displayName").innerText = "Welcome, " + patientName;
    }

    // Button-ku event listener sethu dynamic ID-ah anuppurom
    document.getElementById("downloadBtn").addEventListener("click", function() {
        downloadReport(patientId);
    });

    function downloadReport(id) {
        // ID illai na login page-ku poga sollurom
        if (!id || id === "0" || id === null) {
            alert("Error: Patient ID is missing. Please log in again.");
            window.location.href = "patientlogin.html"; 
            return;
        }

        const btn = document.getElementById("downloadBtn");
        btn.disabled = true;
        btn.innerText = "Downloading...";

        fetch(`https://lifecare-management-system.onrender.com/patients/report/${id}`, {
            method: "GET"
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned: ${response.status} - Report not found`);
            }
            return response.blob(); 
        })
        .then(blob => {
            const fileURL = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = fileURL;
            a.download = `Patient_Report_${id}.pdf`; 
            document.body.appendChild(a);
            a.click();  
            
            window.URL.revokeObjectURL(fileURL);
            a.remove();
            
            btn.disabled = false;
            btn.innerText = "Download Patient Report (PDF)";
        })
        .catch(error => {
            console.error("Error downloading report:", error);
            alert(`Failed: ${error.message}`);
            btn.disabled = false;
            btn.innerText = "Download Patient Report (PDF)";
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>